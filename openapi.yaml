openapi: 3.0.3
info:
  title: API Floricoop
  version: "1.0.0"
  description: |
    Documentación de la API Floricoop.
    Incluye health check de BD y CRUD de productos, clientes, pedidos e items de pedido.

servers:
  - url: http://localhost:{port}
    description: Servidor local
    variables:
      port:
        default: "3000"

tags:
  - name: Health
    description: Endpoints de verificación
  - name: Productos
    description: CRUD de productos
  - name: Clientes
    description: CRUD de clientes
  - name: Pedidos
    description: CRUD de pedidos e items

paths:
  /health/db:
    get:
      tags: [Health]
      summary: Verificación de conexión a la base de datos
      operationId: healthDb
      responses:
        "200":
          description: Conexión exitosa
          content:
            application/json:
              schema: { $ref: "#/components/schemas/HealthResponse" }
              examples:
                ok: { value: { db: true } }
        "500":
          description: Fallo de conexión
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
              examples:
                fail: { value: { db: false, error: "ECONNREFUSED 127.0.0.1:3306" } }

  # =======================
  # Productos
  # =======================
  /api/productos:
    get:
      tags: [Productos]
      summary: Listar productos
      operationId: listProductos
      responses:
        "200":
          description: Lista de productos
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Producto" }
              examples:
                sample:
                  value:
                    - { id: 1, nombre: "Rosa bouquet", precio: 3500, stock: 50, activo: true, creado_en: "2025-10-30T12:00:00Z" }
                    - { id: 2, nombre: "Girasol", precio: 1800, stock: 100, activo: true, creado_en: "2025-10-30T12:00:00Z" }
        "500":
          description: Error interno
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
    post:
      tags: [Productos]
      summary: Crear producto
      operationId: createProducto
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NewProducto" }
            examples:
              sample:
                value: { nombre: "Tulipán rojo", precio: 2800, stock: 10, activo: true }
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: integer, example: 3 }
        "400": { description: Datos inválidos, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "500": { description: Error interno, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /api/productos/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: integer, minimum: 1 }
        description: ID del producto
    get:
      tags: [Productos]
      summary: Obtener un producto por ID
      operationId: getProducto
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: "#/components/schemas/Producto" } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "500": { description: Error interno, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
    patch:
      tags: [Productos]
      summary: Actualizar parcialmente un producto
      operationId: updateProducto
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdateProducto" }
            examples: { sample: { value: { precio: 2990 } } }
      responses:
        "200": { description: Actualizado, content: { application/json: { schema: { type: object, properties: { updated: { type: boolean, example: true } } } } } }
        "400": { description: Datos inválidos, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "500": { description: Error interno, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
    delete:
      tags: [Productos]
      summary: Eliminar un producto
      operationId: deleteProducto
      responses:
        "200": { description: Eliminado, content: { application/json: { schema: { type: object, properties: { deleted: { type: boolean, example: true } } } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "500": { description: Error interno, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  # =======================
  # Clientes
  # =======================
  /api/clientes:
    get:
      tags: [Clientes]
      summary: Listar clientes
      operationId: listClientes
      responses:
        "200":
          description: Lista de clientes
          content:
            application/json:
              schema: { type: array, items: { $ref: "#/components/schemas/Cliente" } }
    post:
      tags: [Clientes]
      summary: Crear cliente
      operationId: createCliente
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NewCliente" }
            examples:
              sample:
                value: { nombre: "Ana Torres", email: "ana@example.com", telefono: "+56 9 1111 2222", direccion: "Santiago" }
      responses:
        "201": { description: Creado, content: { application/json: { schema: { type: object, properties: { id: { type: integer, example: 10 } } } } } }
        "400": { description: Datos inválidos, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /api/clientes/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: integer, minimum: 1 }
    get:
      tags: [Clientes]
      summary: Obtener cliente por ID
      operationId: getCliente
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: "#/components/schemas/Cliente" } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
    patch:
      tags: [Clientes]
      summary: Actualizar cliente
      operationId: updateCliente
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdateCliente" }
      responses:
        "200": { description: Actualizado, content: { application/json: { schema: { type: object, properties: { updated: { type: boolean, example: true } } } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
    delete:
      tags: [Clientes]
      summary: Eliminar cliente
      operationId: deleteCliente
      responses:
        "200": { description: Eliminado, content: { application/json: { schema: { type: object, properties: { deleted: { type: boolean, example: true } } } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  # =======================
  # Pedidos
  # =======================
  /api/pedidos:
    get:
      tags: [Pedidos]
      summary: Listar pedidos
      operationId: listPedidos
      responses:
        "200":
          description: Lista de pedidos
          content:
            application/json:
              schema: { type: array, items: { $ref: "#/components/schemas/Pedido" } }
    post:
      tags: [Pedidos]
      summary: Crear pedido
      operationId: createPedido
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NewPedido" }
            examples:
              sample:
                value: { cliente_id: 1, estado: "PENDIENTE" }
      responses:
        "201": { description: Creado, content: { application/json: { schema: { type: object, properties: { id: { type: integer, example: 20 } } } } } }
        "400": { description: Datos inválidos, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /api/pedidos/{id}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: integer, minimum: 1 }
    get:
      tags: [Pedidos]
      summary: Obtener pedido por ID
      operationId: getPedido
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: "#/components/schemas/Pedido" } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
    patch:
      tags: [Pedidos]
      summary: Actualizar pedido (estado/total)
      operationId: updatePedido
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/UpdatePedido" }
      responses:
        "200": { description: Actualizado, content: { application/json: { schema: { type: object, properties: { updated: { type: boolean, example: true } } } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
    delete:
      tags: [Pedidos]
      summary: Eliminar pedido
      operationId: deletePedido
      responses:
        "200": { description: Eliminado, content: { application/json: { schema: { type: object, properties: { deleted: { type: boolean, example: true } } } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /api/pedidos/{id}/items:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: integer, minimum: 1 }
    get:
      tags: [Pedidos]
      summary: Listar items de un pedido
      operationId: listPedidoItems
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { type: array, items: { $ref: "#/components/schemas/PedidoItem" } }
    post:
      tags: [Pedidos]
      summary: Agregar item a un pedido
      operationId: addPedidoItem
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NewPedidoItem" }
            examples:
              sample:
                value: { producto_id: 2, cantidad: 3, precio_unitario: 1800 }
      responses:
        "201": { description: Creado, content: { application/json: { schema: { type: object, properties: { id: { type: integer, example: 40 } } } } } }
        "400": { description: Datos inválidos, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /api/pedidos/{id}/items/{itemId}:
    parameters:
      - in: path
        name: id
        required: true
        schema: { type: integer, minimum: 1 }
      - in: path
        name: itemId
        required: true
        schema: { type: integer, minimum: 1 }
    patch:
      tags: [Pedidos]
      summary: Actualizar un item del pedido
      operationId: updatePedidoItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                cantidad: { type: integer, minimum: 1 }
                precio_unitario: { type: number, minimum: 0 }
      responses:
        "200": { description: Actualizado, content: { application/json: { schema: { type: object, properties: { updated: { type: boolean, example: true } } } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
    delete:
      tags: [Pedidos]
      summary: Eliminar un item del pedido
      operationId: deletePedidoItem
      responses:
        "200": { description: Eliminado, content: { application/json: { schema: { type: object, properties: { deleted: { type: boolean, example: true } } } } } }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

components:
  schemas:
    Error:
      type: object
      properties:
        error: { type: string, example: "Validación fallida" }

    HealthResponse:
      type: object
      properties:
        db: { type: boolean, example: true }

    # -------- Productos --------
    Producto:
      type: object
      properties:
        id:        { type: integer, example: 1 }
        nombre:    { type: string,  example: "Rosa bouquet" }
        precio:    { type: number,  format: float, example: 3500 }
        stock:     { type: integer, example: 50 }
        activo:    { type: boolean, example: true }
        creado_en: { type: string,  format: date-time, example: "2025-10-30T12:00:00Z" }
    NewProducto:
      type: object
      required: [nombre, precio]
      properties:
        nombre: { type: string, minLength: 2 }
        precio: { type: number, format: float, minimum: 0 }
        stock:  { type: integer, minimum: 0, default: 0 }
        activo: { type: boolean, default: true }
    UpdateProducto:
      type: object
      properties:
        nombre: { type: string, minLength: 2 }
        precio: { type: number, format: float, minimum: 0 }
        stock:  { type: integer, minimum: 0 }
        activo: { type: boolean }

    # -------- Clientes --------
    Cliente:
      type: object
      properties:
        id:        { type: integer }
        nombre:    { type: string }
        email:     { type: string, format: email }
        telefono:  { type: string }
        direccion: { type: string }
        creado_en: { type: string, format: date-time }
    NewCliente:
      type: object
      required: [nombre]
      properties:
        nombre:    { type: string, minLength: 2 }
        email:     { type: string, format: email }
        telefono:  { type: string }
        direccion: { type: string }
    UpdateCliente:
      type: object
      properties:
        nombre:    { type: string, minLength: 2 }
        email:     { type: string, format: email }
        telefono:  { type: string }
        direccion: { type: string }

    # -------- Pedidos --------
    Pedido:
      type: object
      properties:
        id:         { type: integer }
        cliente_id: { type: integer }
        fecha:      { type: string, format: date-time }
        estado:     { type: string, enum: [PENDIENTE, PAGADO, CANCELADO], example: "PENDIENTE" }
        total:      { type: number, format: float }
    NewPedido:
      type: object
      required: [cliente_id]
      properties:
        cliente_id: { type: integer, minimum: 1 }
        estado:     { type: string, enum: [PENDIENTE, PAGADO, CANCELADO], default: PENDIENTE }
    UpdatePedido:
      type: object
      properties:
        estado: { type: string, enum: [PENDIENTE, PAGADO, CANCELADO] }
        total:  { type: number, format: float, minimum: 0 }

    # -------- Items de pedido --------
    PedidoItem:
      type: object
      properties:
        id:             { type: integer }
        pedido_id:      { type: integer }
        producto_id:    { type: integer }
        cantidad:       { type: integer }
        precio_unitario:{ type: number, format: float }
        subtotal:       { type: number, format: float }
    NewPedidoItem:
      type: object
      required: [producto_id, cantidad, precio_unitario]
      properties:
        producto_id:    { type: integer, minimum: 1 }
        cantidad:       { type: integer, minimum: 1 }
        precio_unitario:{ type: number, minimum: 0 }
